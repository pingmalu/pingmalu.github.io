---
layout: post
title: 二级proxy部署
---

shadowsocks:

    apt-get update
    apt-get install -y python-pip python-m2crypto
    pip install shadowsocks

Debian / Ubuntu:

    apt-get install python-pip
    pip install shadowsocks

CentOS:

    yum install python-setuptools && easy_install pip
    pip install shadowsocks

启动：

    ssserver -p 3000 -k password -m aes-128-cfb -d start

停止：

    ssserver -d stop



二级COW架设源码:[https://github.com/cyfdecyf/cow](https://github.com/cyfdecyf/cow)

安装过程：

    curl -L git.io/cow | bash

配置文件路径:

    vim ~/.cow/rc



手工安装：

http://dl.chenyufei.info/cow/0.9.6/cow-linux64-0.9.6.gz

配置文件：

https://raw.github.com/cyfdecyf/cow/0.9.6/doc/sample-config/rc /root/.cow/rc



# 二级proxy部署 第二篇

上面写的是shadowsocks+cow实现二级proxy，接下来用一种简单的方式来实现二级proxy：

首先，一级proxy开启ssh服务。

二级proxy上用SSH端口转发：

	ssh -N -f -D 0.0.0.0:8888 username@ssh.malu.me

输入密码，这段命令意思是连接远程主机ssh.malu.me,然后在本地0.0.0.0地址、端口8888上开启socket5监听。

这样只要访问二级proxy上的socket5代理就能穿过两层代理了。

# 二级proxy部署 自动脚本

相关参数根据实际修改

{% highlight shell %}
#!/usr/bin/expect -f
set timeout 30
set host ssh.malu.me
set name root
set passwd userpasswd
set port 22
set lisenport 8888
spawn sudo /etc/init.d/ssh start
expect "*#"
spawn killall ssh
expect "*#"
spawn ssh -NfR 1234:localhost:2222 $host -l $name -p $port
expect {
	"yes/no" { send "yes\r"; exp_continue }
	"password:" { sleep 1;send "$passwd\r" }
}
expect "*#"
spawn ssh $host -l $name -p $port
expect {
	"yes/no" { send "yes\r"; exp_continue }
	"password:" { sleep 1;send "$passwd\r" }
}
expect "]$"
sleep 1
send "ssh -N -f -D 0.0.0.0:$lisenport root@localhost -p1234\r"
expect {
	"yes/no" { send "yes\r"; exp_continue }
	"password:" { sleep 1;send "$passwd\r" }
}
expect  "]$"
sleep 1
send "exit\r"
expect eof
exit
{% endhighlight %}
