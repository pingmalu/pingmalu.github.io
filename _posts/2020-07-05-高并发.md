---
layout: post
title: 高并发
---

# 基准测试

## 环境

```
ThinkPad E14 
CPU: AMD 4500U
内存: 16G
JDK: 1.8
测试工具：Jmeter
负载：1000线程  ramp-up 5秒 1000循环次数
```

### 执行语句

```
jmeter -n -t 测试计划.jmx -l results.log -e -o out
```

### eg.1

```java
@RequestMapping("buy/get")
public String buy_get() {
    Jedis jedis = jedisPool.getResource();
    String res = jedis.get("jedis:test-99");
    jedis.close();
    return res;
}
```

TPS: 13926.99  13899.51  18116.93

### eg.2

```java
@RequestMapping("buy/get2")
public String buy_get2() {
    return RedisUtil.get("jedis:test-99");
}
```

TPS: 14203.74 18032.31  14112.73

### eg.3

```java
@RequestMapping("buy/get3")
public String buy_get3() {
    ValueOperations operations = redisTemplate.opsForValue();
    return (String) operations.get("RedisTemplate:test-99");
}
```

TPS:  11842.17  11517.69  11489.50

### eg.4

```java
@RequestMapping("buy/get4")
public String buy_get4() {
    return RedisUtil2.strings().get("jedis:test-99");
}
```

TPS: 17779.36  12976.56  17614.63

### eg.5

```java
@RequestMapping("buy/get5")
public R buy_get5() {
    return R("malu99");
}
```

TPS:  18562.52  21023.86  20304.16

### eg.6

```java
@RequestMapping("buy/get6")
public String buy_get6() {
    return "malu99";
}
```

TPS:  21628.64  23030.86  22103.36

## 负载因子

eg.1

```java
private static int l = 0;

@RequestMapping("buy/factor1")
public String buy_factor1() {
    l++;
    if ((l % 10) == 0) {
        l = 0;
        return "malu";
    } else {
        return "error";
    }
}
```

TPS:  22819.07  23470.32  21456.93

加入负载因子对性能几乎没损耗，虽然该方案线程不安全

eg.2

```java
private static int l = 0;
private static long my = 0;

@RequestMapping("buy/factor1")
public String buy_factor1() {
    l++;
    if ((l % 10) == 0) {
        l = 0;
        my++;
        return "malu"+my;
    } else {
        return "error";
    }
}
```

TPS:  22849.83  22617.27 21693.86

返回结果： 

| 第一次    | 第二次    | 第三次    |
| --------- | --------- | --------- |
| malu99654 | malu99671 | malu99517 |



## service

eg.1

```java
@Autowired
buyService buyService;

@RequestMapping("buy/factor2")
public R buy_factor2() {
    return buyService.factor2();
}
```

```java
public interface buyService {
    R factor2();
}
```

```java
@Service
public class buyServiceImpl implements buyService {
    @Override
    public R factor2() {
        return R();
    }
}
```

TPS:  19955.70

eg.2

```java
private static int l = 0;
private static long my = 0;

@Override
public R factor3(){
    l++;
    if ((l % 10) == 0) {
        l = 0;
        my++;
        return R("malu"+my);
    } else {
        return R("error");
    }
}
```

TPS:  22611.13  20362.87 19967.25

返回结果：

| 第一次    | 第二次    | 第三次    |
| --------- | --------- | --------- |
| malu99815 | malu99885 | malu99852 |

eg.3  线程同步

```java
@Override
synchronized public R factor4(){
    l++;
    if ((l % 10) == 0) {
        l = 0;
        my++;
        return R("malu"+my);
    } else {
        return R("error");
    }
}
```

TPS:  18390.13  19664.91  18653.93

返回结果（线程安全）：

| 第一次     | 第二次     | 第三次     |
| ---------- | ---------- | ---------- |
| malu100001 | malu100001 | malu100001 |



eg.5 原子类

```java
private AtomicInteger successNum = new AtomicInteger(0);


/**
 * 原子类
 *
 * @return
 */
@Override
public R factor6() {
    if ((successNum.incrementAndGet() % 10) == 0) {
        my++;
        return R("malu" + my);
    } else {
        return R("error");
    }
}
```

TPS:  19800.02

返回结果（线程安全）：

| 第一次     | 第二次     | 第三次     |
| ---------- | ---------- | ---------- |
| malu100001 | malu100001 | malu100001 |





# 参考：

使用Redis搭建电商秒杀系统  [https://tech.antfin.com/docs/2/63920](https://tech.antfin.com/docs/2/63920)

redis高并发秒杀测试  [https://github.com/14251104246/redis-demo](https://github.com/14251104246/redis-demo)