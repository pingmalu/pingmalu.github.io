---
layout: post
title: SSH反向连接
---

首先2台主机都要安装ssh服务端：

	apt install openssh-server

如果有需要开启root远程登录，可以修改/etc/ssh/sshd_config

找到 PermitRootLogin 一行，改为 PermitRootLogin yes

重启sshd服务

    service ssh restart

### A要控制B ###

A主机：外网，ip：123.123.123.123，sshd端口：22

B主机：内网，sshd端口：22

无论是外网主机A，还是内网主机B都需要跑ssh daemon

### 1.首先在B上执行 ###

    ssh -NfR 1234:localhost:22 user1@123.123.123.123 -p22

这句话的意思是将A主机的1234端口和B主机的22端口绑定，相当于远程端口映射（Remote Port Forwarding）。

### 2.这时在A主机上sshd会listen本地1234端口 ###

    ssh localhost -p1234


### 自动登录 ###

方法1.在内网B主机上生产公钥和私钥

    $ ssh-keygen

...(一直按Enter，最后在~/.ssh/下生成密钥)

    $ ls ~/.ssh/
    id_rsa id_rsa.pub known_hosts

复制B主机上生成的id_rsa.pub公钥到外网A主机上，并将内容加入到~/.ssh/authorized_keys中

方法2.直接在B主机上执行

	$ ssh-copy-id user1@123.123.123.123

### SSH-keygen 根据私钥生成公钥

	$ ssh-keygen -y -f id_rsa

### 用Autossh保持ssh反向隧道一直连接 ###

	autossh -NfR 1234:localhost:2223 user1@123.123.123.123 -p2221

注：默认autossh没有配置环境变量，需要自己设定

    export AUTOSSH_PIDFILE=/var/run/autossh.pid
    export AUTOSSH_POLL=60
    export AUTOSSH_FIRST_POLL=30
    export AUTOSSH_GATETIME=0
    export AUTOSSH_DEBUG=1

为了保证开机时就启动，需要把以上环境变量写入/etc/profile中

然后在/etc/init/rc.local中添加：

	autossh -NfR 1234:localhost:2223 user1@123.123.123.123 -p2221


### 使用curl让反向隧道保持连接

在A主机上配置计划任务：

	*/1 * * * * netstat -lnt4p|grep "sshd: root"|awk '{print $4}'|awk -F ':' '{print $2}'|xargs -i curl localhost:{}

定时向本地的隧道端口请求数据

# 其他技巧

### ssh实现SOCKS动态端口转发

示例：

```
ssh -D 9990 -N -f -C -q user@remote.host
```

说明：

    -D 启动一个SOCKS服务并监听本地对应端口
    -f 后台运行
    -C 压缩请求数据
    -q 使用静默模式
    -N 不执行远程命令


### ssh使用代理连接

使用ncat.exe进行代理连接，该工具在nmap套件里面，下载地址：[https://nmap.org/dist/](https://nmap.org/dist/)

比如下载 *https://nmap.org/dist/nmap-7.92-win32.zip* 在里面找到ncat.exe文件

连接时使用代理参数：

```
ssh -o "ProxyCommand=ncat --proxy-type socks5 --proxy 127.0.0.1:50001 %h %p" root@111.12.12.12
```

如果放bat脚本里可这么写：

```
wt -w 0 new-tab cmd /k ssh -o """ProxyCommand=ncat --proxy-type socks5 --proxy 127.0.0.1:50001 %%h %%p""" root@111.12.12.12
```

### git ssh使用代理

编辑文件：~/.ssh/config

```
host github.com
    user git
    hostname github.com
    port 22
    proxycommand ncat --proxy-type socks5 --proxy 127.0.0.1:50001 %h %p
```



### ssh中继隧道连接


默认只能通过ssh localhost -p来连接，如果要实现远程登录内网B主机，可以在A主机上再开一个本地端口转发：

	ssh -g -L 80:localhost:1234 localhost

远程就可以通过A主机的80端口去连接B主机了。

我们甚至可以启动socket5隧道：

	ssh -N -f -D 0.0.0.0:8888 root@localhost -p1234

### ssh 指定私钥文件:

	ssh -i /root/.ssh/idrsa root@malu.me -p 2111


### ssh取消主机密钥检查

1.使用ssh连接远程主机时加上“-o StrictHostKeyChecking=no”的选项，如下：


	ssh  -o StrictHostKeyChecking=no  192.168.xxx.xxx

2.一个彻底去掉这个提示的方法是，修改/etc/ssh/ssh_config文件（或$HOME/.ssh/config）中的配置，添加如下两行配置：


	StrictHostKeyChecking no
	UserKnownHostsFile /dev/null

### ssh取消警告

取消每次ssh登录，弹出Warning:Permanently added (RSA) to the list of known hosts的警告

修改配置文件 /etc/ssh/ssh_config

```
StrictHostKeyChecking ask
UserKnownHostsFile ~/.ssh/known_hosts
```

### 避免SSH连接因超时闲置断开

在服务器上打开 **/etc/ssh/sshd_config** 加入配置：

```
ClientAliveInterval 1200
ClientAliveCountMax 3
```

