---
layout: post
title: Nginx日常笔记
---


### 快速安装

	apt-get install nginx

### 配置文件 /etc/nginx/nginx.conf


Nginx的配置文件是/etc/nginx/nginx.conf，其中设置了一些必要的参数，我们发现其中这样的语句：

include /etc/nginx/sites-enabled/*

可以看出/etc/nginx/sites-enabled/default文件也是一个核心的配置文件，其中包含了主要的配置信息，

如服务器跟目录、服务器名称、location信息和server信息。

### 开启反向代理

开启代理池：

	upstream svn.com {
	    server 192.168.1.210:80; #Apache
	}

反向代理配置：

        location / {
                proxy_pass  http://svn.com;

                #Proxy Settings
                proxy_redirect     off;
                #For relay ip
                proxy_set_header   Host             $host;
                proxy_set_header   X-Real-IP        $remote_addr;
                proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

                proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
                proxy_max_temp_file_size 0;
                proxy_connect_timeout      90;
                proxy_send_timeout         90;
                proxy_read_timeout         90;
                proxy_buffer_size          4k;
                proxy_buffers              4 32k;
                proxy_busy_buffers_size    64k;
                proxy_temp_file_write_size 64k;
                client_max_body_size 20M;
        }


### 开启缓存

缓存目录配置：http

	#proxy cache
	proxy_cache_path /data/nginx/cache/webserver levels=1:2 keys_zone=webserver:20m max_size=1g;

然后新建缓存目录：

	mkdir -pv /data/nginx/cache/webserver


添加配置规则：http server

        #proxy cache
        #add_header X-Via $server_addr;
        add_header X-Cache $upstream_cache_status;

        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$ {
                proxy_pass  http://svn.com;
                #proxy cache
                proxy_cache webserver;
                proxy_cache_valid 200 302 1m;
                proxy_cache_valid 404 1m;
                proxy_cache_valid 1m;
                proxy_cache_valid any 1m;
        }


### 关闭Web服务器头信息(Header)里的Server值

默认会看到nginx返回的头信息里有版本号，比如：Server:nginx/1.4.6 (Ubuntu)

将这个信息去除

http{}里面加：

    server_tokens off;

### 上传文件大小配置

默认情况下使用nginx反向代理上传超过2MB的文件，会报错413 Request Entity Too Large

解决这个方法很简单,修改配置client_max_body_size值即可 http server location：

	client_max_body_size 10M;

### 添加HTTPS支持：

在http server里添加

        listen 443 ssl;
        ssl on;
        ssl_certificate /etc/nginx/ssl/svn.com.crt;
        ssl_certificate_key /etc/nginx/ssl/svn.com.key;


### 本人完整的配置如下：

{% highlight config %}
upstream svn.com {
    server 192.168.1.210:80; #Apache
}

#proxy cache
proxy_cache_path /data/nginx/cache/webserver levels=1:2 keys_zone=webserver:20m max_size=1g;

server {
        listen 80 default_server;
        listen [::]:80 default_server ipv6only=on;

        listen 443 ssl;
        #同时开启80和443是这边ssl要注释掉!
        #ssl on;
        ssl_certificate /etc/nginx/ssl/svn.com.crt;
        ssl_certificate_key /etc/nginx/ssl/svn.com.key;

        root /usr/share/nginx/html;
        index index.html index.htm;

        server_name svn.com;

        #proxy cache
        #add_header X-Via $server_addr;
        add_header X-Cache $upstream_cache_status;

        location / {
                proxy_pass  http://svn.com;

                #Proxy Settings
                proxy_redirect     off;
                #For relay ip
                proxy_set_header   Host             $host;
                proxy_set_header   X-Real-IP        $remote_addr;
                proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

                proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
                proxy_max_temp_file_size 0;
                proxy_connect_timeout      90;
                proxy_send_timeout         90;
                proxy_read_timeout         90;
                proxy_buffer_size          4k;
                proxy_buffers              4 32k;
                proxy_busy_buffers_size    64k;
                proxy_temp_file_write_size 64k;
                client_max_body_size 20M;
        }

        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|js|css|ico)$ {
                proxy_pass  http://svn.com;
                #proxy cache
                proxy_cache_valid 404 10s;
                proxy_cache webserver;
                proxy_cache_valid 200 302 1m;
                proxy_cache_valid 1m;
                proxy_cache_valid any 1m;
                #proxy_cache_key $host$uri$is_args$args;
        }
}
{% endhighlight %}