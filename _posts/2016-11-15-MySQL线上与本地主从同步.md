---
layout: post
title:  "MySQL线上与本地主从同步"
---

### 运行环境：

线上：RDS（内网）+ECS  

本地：xampp

由于本地只能访问ECS，需要在ECS上架设mysql代理：

参考这篇笔记：[http://git.malu.me/MySQL-Proxy/](http://git.malu.me/MySQL-Proxy/)

### ECS配置（作为主服务器master）:

修改配置文件:

	#vim /etc/my.cnf
    
       [mysqld]
       log-bin=mysql-bin   //[必须]启用二进制日志
       server-id=1         //[必须]服务器唯一ID，默认是1

重启mysql：

	/etc/init.d/mysql restart

在主服务器上建立帐户mysync并授权给slave主机:

	mysql -uroot -h localhost

	mysql> GRANT REPLICATION SLAVE ON *.* to 'mysync'@'%' identified by 'passwd';

	mysql> show master status;    #查看master的状态
	+------------------+----------+--------------+------------------+
	| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
	+------------------+----------+--------------+------------------+
	| mysql-bin.000002 |      532 |              |                  |
	+------------------+----------+--------------+------------------+
	1 row in set (0.00 sec)

	注：执行完此步骤后不要再操作主服务器MYSQL，防止主服务器状态值Position变化

### 本地xampp配置（作为从服务器slave）：

修改配置文件:

	X:\Xampp\mysql\bin\my.ini   #xampp默认配置文件

    [mysqld]
    log-bin=mysql-bin   //[不是必须]启用二进制日志
    server-id=2         //[必须]服务器唯一ID，默认是1，不要与master一样

配置Slave：

	mysql> change master to  master_host='mysql.malu.me',master_port=3306,master_user='mysync',master_password='passwd',master_log_file='mysql-bin.000001',master_log_pos=532;

	注：master_log_pos即为master主机状态里的Position

	mysql> show slave status\G   #检查slave的状态

		*************************** 1. row ***************************
	               Slave_IO_State: Waiting for master to send event
	                  Master_Host: mysql.malu.me
	                  Master_User: mysync
	                  Master_Port: 3306
	                Connect_Retry: 60
	              Master_Log_File: mysql-bin.000001
	          Read_Master_Log_Pos: 532
	               Relay_Log_File: mysql-relay-bin.000008
	                Relay_Log_Pos: 695
	        Relay_Master_Log_File: mysql-bin.000001
	             Slave_IO_Running: Yes
	            Slave_SQL_Running: Yes
	              Replicate_Do_DB:
	          Replicate_Ignore_DB:
	           Replicate_Do_Table:
	       Replicate_Ignore_Table:
	      Replicate_Wild_Do_Table:
	  Replicate_Wild_Ignore_Table:
	                   Last_Errno: 0
	                   Last_Error:
	                 Skip_Counter: 0
	          Exec_Master_Log_Pos: 532
	              Relay_Log_Space: 868
	              Until_Condition: None
	               Until_Log_File:
	                Until_Log_Pos: 0
	           Master_SSL_Allowed: No
	           Master_SSL_CA_File:
	           Master_SSL_CA_Path:
	              Master_SSL_Cert:
	            Master_SSL_Cipher:
	               Master_SSL_Key:
	        Seconds_Behind_Master: 0
	Master_SSL_Verify_Server_Cert: No
	                Last_IO_Errno: 0
	                Last_IO_Error:
	               Last_SQL_Errno: 0
	               Last_SQL_Error:
	  Replicate_Ignore_Server_Ids:
	             Master_Server_Id: 1
	                  Master_UUID:
	             Master_Info_File: X:\Xampp\mysql\data2\master.info
	                    SQL_Delay: 0
	          SQL_Remaining_Delay: NULL
	      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it
	           Master_Retry_Count: 86400
	                  Master_Bind:
	      Last_IO_Error_Timestamp:
	     Last_SQL_Error_Timestamp:
	               Master_SSL_Crl:
	           Master_SSL_Crlpath:
	           Retrieved_Gtid_Set:
	            Executed_Gtid_Set:
	                Auto_Position: 0

接下来往RDS写入数据的时候会自动同步到本地mysql